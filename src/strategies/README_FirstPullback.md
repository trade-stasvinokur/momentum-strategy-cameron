## First Pullback – внутридневная стратегия «первый откат»

**First Pullback** — лёгкий HTTP‑сервис (FastAPI), который *для заданного тикера и торгового дня* определяет, появился ли сигнал «первого отката» на тайм‑фреймах 1 мин и 5 мин.

1. Загружает исторические свечи через Tinkoff Invest API: первые 15 мин (1 мин) и 30 мин (5 мин) после открытия сессии ([developer.tinkoff.ru][5]).
2. Фиксирует стартовый импульс (первая свеча, обновляющая максимум) и его пик.
3. Отслеживает последовательность свечей, не пробивающих максимум (откат).
4. Проверяет условия качества:

   * импульс ≥ 3 % от цены открытия  ([Warrior Trading][6]);
   * объём каждой откатной свечи < объёма импульса ([Warrior Trading][3]);
   * глубина отката ≤ 50 % высоты импульса ([Reddit][4]).
5. Если следующая свеча пробивает хай последней откатной и объём остаётся высоким, паттерн считается сработавшим и расчёт выдаёт `entry_price`, `stop_price`, `target_price`, `trigger_time`.

Сервис готов к Docker‑развёртыванию либо вызову напрямую из оркестратора.

---

## ⚙️ Быстрый старт

### 1. Подготовка окружения

1. **Python ≥ 3.13**.
2. Скопируйте `.env.example` → `.env` и задайте переменные:

```dotenv
# Токен Tinkoff Invest API
TINKOFF_INVEST_TOKEN=your_token_here
# Часовой пояс (для логов)
TZ=Europe/Moscow
# Порт, который слушает сервис
PORT=8005
```

3. Зависимости:

```bash
pip install uv
```

### 2. Запуск локально

```bash
uv run uvicorn first_pullback:app --host 0.0.0.0 --port 8005
```

Проверка:

```bash
curl -s "http://localhost:8005/first-pullback?ticker=SBER&uid=f0eac4d5-4753-4c05-857e-676f25c18e68&date=2025-07-28"
```

Пример ответа:

```json
{
  "ticker": "SBER",
  "date": "2025-07-28",
  "first_pullback_1min": {
    "triggered": true,
    "entry_price": 277.10,
    "stop_price": 274.45,
    "target_price": 282.30,
    "trigger_time": "2025-07-28T07:06:00+00:00"
  },
  "first_pullback_5min": {
    "triggered": false,
    "entry_price": null,
    "stop_price": null,
    "target_price": null,
    "trigger_time": null
  }
}
```

### 3. Запуск в Docker

```bash
docker compose up first_pullback
```

`docker-compose.yml` уже содержит сервис **first\_pullback** с публикацией порта `8005`.

---

## 🧰 Конфигурация

| Переменная             | Обязательно | По умолчанию    | Назначение                                                   |
| ---------------------- | ----------- | --------------- | ------------------------------------------------------------ |
| `TINKOFF_INVEST_TOKEN` | да          | —               | Доступ к Market Data API Tinkoff ([developer.tinkoff.ru][5]) |
| `TZ`                   | нет         | `Europe/Moscow` | Локальная тайзона для логов                                  |
| `PORT`                 | нет         | `8005`          | Порт, на котором слушает FastAPI                             |

---

## 🔄 Как это работает

1. Клиент делает **GET** `/first-pullback?ticker&uid&date`.
2. Сервис запрашивает свечи:

   * `CANDLE_INTERVAL_1_MIN` (первые 15 мин);
   * `CANDLE_INTERVAL_5_MIN` (первые 30 мин).
3. Алгоритм First Pullback:

   1. Фиксирует цену открытия и пиковый хай импульса.
   2. Определяет старт отката — первую свечу без обновления хая.
   3. Считает минимум отката и объём каждой свечи.
   4. Проверяет правила «качественного» отката (см. выше).
   5. При подтверждении:

      * `entry_price` = хай последней откатной свечи;
      * `stop_price` = минимум отката;
      * `target_price` = пик импульса;
      * `trigger_time` = время пробойной свечи.
4. Результат сериализуется через Pydantic и возвращается клиенту.
5. Логирование (`INFO`) — ключевые этапы и параметры; проблемы Market Data API — `ERROR`. CORS настроен на `'*'` для простоты интеграции.

---

## 🗄️ Логи и хранение данных

По умолчанию сервис пишет в stdout → `docker logs first_pullback`. Для детальной отладки можно запустить `uvicorn` с `--log-level debug` и видеть все пришедшие свечи.

---

## 📂 Структура проекта

```
first_pullback/
┣ first_pullback.py        # FastAPI‑приложение и логика стратегии
┣ DockerfileFirstPullback  # python:3.13‑slim, ENTRYPOINT ["uv", "run", "uvicorn ..."]
┗ README_FirstPullback.md  # этот файл
```

---

### ✨ Готово

После `docker compose up` окружение содержит:

* **first\_pullback** — REST API стратегии First Pullback
* (опционально) **orchestrator** — планировщик, который по расписанию вызывает стратегию и складывает результаты в БД/лог.

Используйте сервис напрямую через cURL/Postman или импортируйте эндпоинт в свои трейдинг‑скрипты.