

# Flat‚ÄëBreakout¬†‚Äì –≤–Ω—É—Ç—Ä–∏–¥–Ω–µ–≤–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è Flat‚ÄëTop / Flat‚ÄëBottom

**Flat‚ÄëBreakout**¬†‚Äî HTTP‚Äë—Å–µ—Ä–≤–∏—Å (FastAPI), –∫–æ—Ç–æ—Ä—ã–π *–¥–ª—è –∑–∞–¥–∞–Ω–Ω–æ–≥–æ —Ç–∏–∫–µ—Ä–∞ –∏ –¥–Ω—è* –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç, —Å—Ä–∞–±–æ—Ç–∞–ª–∏¬†–ª–∏ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –ø–ª–æ—Å–∫–æ–≥–æ –ø—Ä–æ–±–æ—è –≤–≤–µ—Ä—Ö (Flat‚ÄëTop) –∏ –ø—Ä–æ–±–æ—è –≤–Ω–∏–∑ (Flat‚ÄëBottom) –Ω–∞ 1‚Äë –∏ 5‚Äë–º–∏–Ω—É—Ç–Ω—ã—Ö –≥—Ä–∞—Ñ–∏–∫–∞—Ö.

1. –ü–æ–ª—É—á–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ —Å–≤–µ—á–∏ (Tinkoff Invest API) 1‚ÄØ–º–∏–Ω –∏¬†5‚ÄØ–º–∏–Ω –∑–∞ —Ç–æ—Ä–≥–æ–≤—ã–π –¥–µ–Ω—å.
2. –í—ã–¥–µ–ª—è–µ—Ç –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ —É—Ä–æ–≤–Ω–∏ —Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏—è/–ø–æ–¥–¥–µ—Ä–∂–∫–∏, –∫¬†–∫–æ—Ç–æ—Ä—ã–º —Ü–µ–Ω–∞ –≤–æ–∑–≤—Ä–∞—â–∞–ª–∞—Å—å **‚â•‚ÄØ2¬†—Ä–∞–∑**.
3. –ò—â–µ—Ç –ø–µ—Ä–≤—ã–π –ø—Ä–æ–±–æ–π/–ø—Ä–æ–±–æ–π –≤–Ω–∏–∑ —ç—Ç–∏—Ö —É—Ä–æ–≤–Ω–µ–π.
4. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç JSON¬†—Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –¥–ª—è —á–µ—Ç—ã—Ä—ë—Ö –∫–æ–º–±–∏–Ω–∞—Ü–∏–π:
   * Flat‚ÄëTop¬†1‚ÄØ–º
   * Flat‚ÄëBottom¬†1‚ÄØ–º
   * Flat‚ÄëTop¬†5‚ÄØ–º
   * Flat‚ÄëBottom¬†5‚ÄØ–º  
   –î–ª—è –∫–∞–∂–¥–æ–≥–æ: `triggered`, `entry_price`, `stop_price`, `trigger_time`.

–°–µ—Ä–≤–∏—Å —É–ø–∞–∫–æ–≤–∞–Ω –≤¬†Docker‚Äë–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏ –º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –∞–≤—Ç–æ–Ω–æ–º–Ω–æ –∏–ª–∏ –≤—ã–∑—ã–≤–∞—Ç—å—Å—è –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.

---

## ‚öôÔ∏è –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è

1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ **Python¬†‚â•‚ÄØ3.13**
2. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ `.env.example` ‚Üí `.env` –∏ –∑–∞–¥–∞–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:

```dotenv
# –¢–æ–∫–µ–Ω Tinkoff Invest API
TINKOFF_INVEST_TOKEN=your_token_here
# –ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é Moscow)
TZ=Europe/Moscow
# –ü–æ—Ä—Ç, –∫–æ—Ç–æ—Ä—ã–π —Å–ª—É—à–∞–µ—Ç —Å–µ—Ä–≤–∏—Å
PORT=8003
```

3. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:

```bash
pip install uv
```

### 2. –ó–∞–ø—É—Å–∫ –ª–æ–∫–∞–ª—å–Ω–æ

```bash
uv run uvicorn flat_breakout:app --host 0.0.0.0 --port 8003
```

–ü—Ä–æ–≤–µ—Ä—å –∑–∞–ø—Ä–æ—Å–æ–º:

```bash
curl -s "http://localhost:8003/flat-breakout?ticker=SBER&uid=f0eac4d5-4753-4c05-857e-676f25c18e68&date=2025-07-28"
```

–ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞:

```json
{
  "ticker": "SBER",
  "date": "2025-07-28",
  "flat_top_1min": {
    "triggered": false,
    "entry_price": null,
    "stop_price": null,
    "trigger_time": null
  },
  "flat_bottom_1min": {
    "triggered": false,
    "entry_price": null,
    "stop_price": null,
    "trigger_time": null
  },
  "flat_top_5min": {
    "triggered": false,
    "entry_price": null,
    "stop_price": null,
    "trigger_time": null
  },
  "flat_bottom_5min": {
    "triggered": false,
    "entry_price": null,
    "stop_price": null,
    "trigger_time": null
  }
}
```

### 3. –ó–∞–ø—É—Å–∫ –≤ Docker

```bash
docker compose up flat_breakout
```

`docker-compose.yml` —É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–µ—Ä–≤–∏—Å **flat_breakout** —Å –ø—É–±–ª–∏–∫–∞—Ü–∏–µ–π –ø–æ—Ä—Ç–∞¬†`8003`.

---

## üß∞ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è              | –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ | –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é    | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ                              |
| ----------------------- | ----------- | --------------- | --------------------------------------- |
| `TINKOFF_INVEST_TOKEN`  | –¥–∞          | ‚Äî               | –î–æ—Å—Ç—É–ø –∫ Market¬†Data API Tinkoff        |
| `TZ`                    | –Ω–µ—Ç         | `Europe/Moscow` | –õ–æ–∫–∞–ª—å–Ω–∞—è —Ç–∞–π–∑–æ–Ω–∞ –¥–ª—è –ª–æ–≥–æ–≤             |
| `PORT`                  | –Ω–µ—Ç         | `8003`          | –ü–æ—Ä—Ç, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–º —Å–ª—É—à–∞–µ—Ç FastAPI        |

---

## üîÑ –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

1. –ö–ª–∏–µ–Ω—Ç –¥–µ–ª–∞–µ—Ç **GET** `/flat-breakout?ticker&uid&date`.
2. –°–µ—Ä–≤–∏—Å –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç —Å–≤–µ—á–∏:
   * `CANDLE_INTERVAL_1_MIN`
   * `CANDLE_INTERVAL_5_MIN`  
   –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ *[00:00 UTC –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –¥–Ω—è; 00:00 UTC —Å–ª–µ–¥—É—é—â–µ–≥–æ –¥–Ω—è]*.
3. –î–ª—è –∫–∞–∂–¥–æ–π —Å–µ—Ä–∏–∏ —Å–≤–µ—á–µ–π –∞–ª–≥–æ—Ä–∏—Ç–º:
   1. –ü—Ä–æ—Ö–æ–¥–∏—Ç –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ, –∑–∞–ø–æ–º–∏–Ω–∞—è –º–∞–∫—Å–∏–º—É–º (–¥–ª—è Flat‚ÄëTop) –∏–ª–∏ –º–∏–Ω–∏–º—É–º (–¥–ª—è Flat‚ÄëBottom), –∫–æ—Ç–æ—Ä—ã–π –≤—Å—Ç—Ä–µ—á–∞–ª—Å—è **‚â•‚ÄØ2¬†—Ä–∞–∑**.
   2. –ö–∞–∫ —Ç–æ–ª—å–∫–æ –ø–æ—è–≤–ª—è–µ—Ç—Å—è —Å–≤–µ—á–∞, –ø—Ä–æ–±–∏–≤–∞—é—â–∞—è (–∏–ª–∏ –ø—Ä–æ–±–∏–≤–∞—é—â–∞—è –≤–Ω–∏–∑) —ç—Ç–æ—Ç —É—Ä–æ–≤–µ–Ω—å, —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è:
      * `entry_price` ‚Äî —É—Ä–æ–≤–µ–Ω—å —Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏—è/–ø–æ–¥–¥–µ—Ä–∂–∫–∏;
      * `stop_price` ‚Äî –±–ª–∏–∂–∞–π—à–∏–π –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω—ã–π —ç–∫—Å—Ç—Ä–µ–º—É–º –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∫–∞—Å–∞–Ω–∏—è;
      * `trigger_time` ‚Äî —à—Ç–∞–º–ø –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–æ–±–æ–π–Ω–æ–π —Å–≤–µ—á–∏.
4. –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–µ—Ä–∏–∞–ª–∏–∑—É—é—Ç—Å—è —á–µ—Ä–µ–∑ Pydantic –∏ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è –∫–ª–∏–µ–Ω—Ç—É.
5. –í¬†–ª–æ–≥–∏ (`INFO`) –ø–∏—à—É—Ç—Å—è –∫–ª—é—á–µ–≤—ã–µ —Å–æ–±—ã—Ç–∏—è; –æ—à–∏–±–∫–∏ API ‚Äî —É—Ä–æ–≤–Ω–µ–º `ERROR`.

---

## üóÑÔ∏è –õ–æ–≥–∏ –∏ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö

–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–µ—Ä–≤–∏—Å –ø–∏—à–µ—Ç –≤¬†stdout ‚Üí `docker logs flat_breakout`.  
–ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ `uvicorn` –º–æ–∂–Ω–æ —É–≤–µ–ª–∏—á–∏—Ç—å –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç—å –ª–æ–≥–æ–≤: `--log-level debug` ‚Äî –±—É–¥—É—Ç –≤–∏–¥–Ω—ã –≤—Å–µ –≤—Ö–æ–¥—è—â–∏–µ —Å–≤–µ—á–∏ –∏ –ø–æ—à–∞–≥–æ–≤—ã–π —Ö–æ–¥ –∞–ª–≥–æ—Ä–∏—Ç–º–∞.

---

## üìÇ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
flat_breakout/
‚î£ flat_breakout.py          # FastAPI‚Äë–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏ –ª–æ–≥–∏–∫–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
‚î£ DockerfileFlatBreakout    # python:3.13‚Äëslim, ENTRYPOINT ["uv", "run", "uvicorn ..."]
‚îó README_FlatBreakout.md    # —ç—Ç–æ—Ç —Ñ–∞–π–ª
```

---

### ‚ú® –ì–æ—Ç–æ–≤–æ

–ü–æ—Å–ª–µ `docker compose up` –æ–∫—Ä—É–∂–µ–Ω–∏–µ –≤—ã–≥–ª—è–¥–∏—Ç —Ç–∞–∫:

* **flat_breakout**¬†‚Äî REST¬†API —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ Flat‚ÄëBreakout
* **orchestrator**¬†‚Äî –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫, –∫–æ—Ç–æ—Ä—ã–π –≤—ã–∑—ã–≤–∞–µ—Ç —Å–µ—Ä–≤–∏—Å—ã –∏ –ª–æ–≥–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç.

–ò–Ω—Ç–µ–≥—Ä–∏—Ä—É–π—Ç–µ —Å–µ—Ä–≤–∏—Å –≤ —Å–≤–æ–∏ —Ç—Ä–µ–π–¥–∏–Ω–≥‚Äë—Å–∫—Ä–∏–ø—Ç—ã –∏–ª–∏ –≤—ã–∑—ã–≤–∞–π—Ç–µ –Ω–∞–ø—Ä—è–º—É—é —á–µ—Ä–µ–∑ cURL/Postman.